#!/bin/bash

# Pre-commit hook: Ensure wp-migrate.sh and its checksum are rebuilt when src/ files change
# This prevents committing source changes without updating the built file and checksum

# Check if any src/ files are being committed
if git diff --cached --name-only | grep -q "^src/"; then
  missing_files=()

  # Check if wp-migrate.sh is also being committed
  if ! git diff --cached --name-only | grep -q "^wp-migrate.sh$"; then
    missing_files+=("wp-migrate.sh")
  fi

  # Check if wp-migrate.sh.sha256 is also being committed
  if ! git diff --cached --name-only | grep -q "^wp-migrate.sh.sha256$"; then
    missing_files+=("wp-migrate.sh.sha256")
  fi

  # If any required files are missing, block the commit
  if [ ${#missing_files[@]} -gt 0 ]; then
    echo ""
    echo "‚ùå ERROR: You modified src/ but didn't update all required files"
    echo ""
    echo "Missing files:"
    for file in "${missing_files[@]}"; do
      echo "  - $file"
    done
    echo ""
    echo "The built file and its checksum must be updated when source files change."
    echo ""
    echo "To fix this:"
    echo "  1. Run: make build"
    echo "  2. Run: git add wp-migrate.sh wp-migrate.sh.sha256"
    echo "  3. Try your commit again"
    echo ""
    exit 1
  fi
fi

# Hook passed - allow commit
exit 0
